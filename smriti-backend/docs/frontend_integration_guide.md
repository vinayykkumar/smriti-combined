# Smriti Backend API - Frontend Integration Guide (v2)

## üöÄ Production API

**Base URL:** `https://smriti-backend-r293.onrender.com`

---

## üîë Understanding User Identifiers

### userId vs username vs email

| Field | What It Is | Example | Purpose |
|-------|------------|---------|---------|
| **userId** | System-generated ID | `"69622cb9b68548496d222139"` | Internal database identifier (never shown to user) |
| **username** | User-chosen name | `"johndoe"` | Login identifier & display name |
| **email** | User's email | `"john@example.com"` | Login identifier & security |

**Key Points:**
- ‚úÖ **userId**: Automatically generated by backend - **never ask user for this**
- ‚úÖ **username**: User types during signup - **show in UI**
- ‚úÖ **email**: User types during signup - **show in UI**
- ‚úÖ Users can login with **either username OR email**

---

## üìã Authentication Flow

### 1. Signup
**What Frontend Collects:**
```javascript
{
  username: "johndoe",      // User types this
  email: "john@example.com", // User types this  
  password: "secret123"      // User types this
}
```

**What Backend Returns:**
```javascript
{
  success: true,
  data: {
    userId: "69622...",      // ‚Üê Backend generates this
    username: "johndoe",
    email: "john@example.com",
    token: "eyJhbGci..."
  }
}
```

**What Frontend Stores:**
```javascript
await AsyncStorage.setItem('userId', data.userId);       // For internal use
await AsyncStorage.setItem('username', data.username);   // For display
await AsyncStorage.setItem('email', data.email);         // For display
await AsyncStorage.setItem('token', data.token);         // For auth
```

**What Frontend Displays:**
```javascript
// Profile screen
<Text>Welcome, {username}!</Text>  // Show username
<Text>{email}</Text>                // Show email
// Never show userId to user
```

### 2. Login (Username OR Email)
**Option 1: Login with username**
```javascript
{
  username: "johndoe",
  password: "secret123"
}
```

**Option 2: Login with email**
```javascript
{
  email: "john@example.com",
  password: "secret123"
}
```

**Both return the same response:**
```javascript
{
  success: true,
  data: {
    userId: "69622...",      // Same ID as signup
    username: "johndoe",
    email: "john@example.com",
    token: "eyJhbGci..."     // New token
  }
}
```

---

## üì° API Endpoints

### Authentication

#### Check Username Availability
```
GET /api/auth/check-username/{username}
```
**No authentication required**

**Response:**
```json
{
  "success": true,
  "available": false,
  "message": "Username is already taken"
}
```

**Usage:**
```javascript
const checkUsername = async (username) => {
  const res = await fetch(`${API_URL}/api/auth/check-username/${username}`);
  const data = await res.json();
  return data.available; // true or false
};
```

---

#### User Signup
```
POST /api/auth/signup
```

**Request:**
```json
{
  "username": "johndoe",
  "email": "john@example.com",
  "password": "secret123"
}
```

**Validation:**
- Username: 3-50 characters, unique
- Email: 5-100 characters, unique
- Password: 6-128 characters

**Success (201):**
```json
{
  "success": true,
  "message": "User registered successfully",
  "data": {
    "userId": "69622cb9b68548496d222139",
    "username": "johndoe",
    "email": "john@example.com",
    "token": "eyJhbGci..."
  }
}
```

**Errors:**
- `409`: Username already taken
- `409`: Email already registered
- `400`: Validation error

---

#### User Login
```
POST /api/auth/login
```

**Request (username OR email):**
```json
{
  "username": "johndoe",  // OR "email": "john@example.com"
  "password": "secret123"
}
```

**Success (200):**
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "userId": "69622cb9b68548496d222139",
    "username": "johndoe",
    "email": "john@example.com",
    "token": "eyJhbGci..."
  }
}
```

**Errors:**
- `401`: Incorrect credentials
- `400`: Neither username nor email provided

---

#### Get Current User
```
GET /api/auth/me
```

**Headers:**
```
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "user": {
    "id": "69622cb9b68548496d222139",
    "username": "johndoe",
    "email": "john@example.com",
    "createdAt": "2026-01-10T12:00:00.000Z"
  }
}
```

---

### Posts

#### Get All Posts
```
GET /api/posts/?skip=0&limit=20
```

**Headers:**
```
Authorization: Bearer <token>
```

**Query Params:**
- `skip`: Offset (default: 0, min: 0)
- `limit`: Max results (default: 50, max: 100, min: 1)

**Response:**
```json
{
  "success": true,
  "message": "Posts retrieved successfully",
  "data": {
    "count": 2,
    "posts": [
      {
        "postId": "507f1f77bcf86cd799439012",
        "contentType": "note",
        "title": "My Reflection",
        "textContent": "Today I learned...",
        "author": {
          "userId": "69622...",
          "username": "johndoe"
        },
        "createdAt": "2026-01-10T12:00:00.000Z"
      }
    ]
  }
}
```

---

#### Create Post
```
POST /api/posts/
```

**Headers:**
```
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**Note Post:**
```javascript
const formData = new FormData();
formData.append('content_type', 'note');
formData.append('title', 'My Reflection');
formData.append('text_content', 'Today I learned...');
```

**Link Post:**
```javascript
formData.append('content_type', 'link');
formData.append('title', 'Article');
formData.append('link_url', 'https://example.com');
formData.append('text_content', 'Optional description');
```

**Document Post:**
```javascript
formData.append('content_type', 'document');
formData.append('title', 'Important Doc');
formData.append('document', {
  uri: fileUri,
  type: 'application/pdf',
  name: 'doc.pdf'
});
```

**Validation:**
- Title: Max 200 chars
- Text: Max 100,000 chars
- URL: Max 2,048 chars
- Document: Max 10MB (pdf, doc, docx, txt)

---

#### Delete Post
```
DELETE /api/posts/{postId}
```

**Headers:**
```
Authorization: Bearer <token>
```

**Success (200):**
```json
{
  "success": true,
  "message": "Post deleted successfully"
}
```

**Errors:**
- `403`: Not authorized (not your post)
- `404`: Post not found

---

## üíª React Native Implementation

### Complete Auth Example
```javascript
import axios from 'axios';
import AsyncStorage from '@react-native-async-storage/async-storage';

const API_URL = 'https://smriti-backend-r293.onrender.com';

const api = axios.create({
  baseURL: API_URL,
  timeout: 30000,
});

// Check username availability
export const checkUsername = async (username) => {
  const res = await api.get(`/api/auth/check-username/${username}`);
  return res.data.available;
};

// Signup
export const signup = async (username, email, password) => {
  const res = await api.post('/api/auth/signup', {
    username,
    email,
    password,
  });
  
  if (res.data.success) {
    const { userId, username, email, token } = res.data.data;
    
    // Store all data
    await AsyncStorage.multiSet([
      ['userId', userId],
      ['username', username],
      ['email', email],
      ['token', token],
    ]);
    
    return res.data;
  }
};

// Login (with username OR email)
export const login = async (identifier, password) => {
  // Determine if identifier is email or username
  const isEmail = identifier.includes('@');
  
  const res = await api.post('/api/auth/login', {
    [isEmail ? 'email' : 'username']: identifier,
    password,
  });
  
  if (res.data.success) {
    const { userId, username, email, token } = res.data.data;
    
    await AsyncStorage.multiSet([
      ['userId', userId],
      ['username', username],
      ['email', email],
      ['token', token],
    ]);
    
    return res.data;
  }
};

// Get current user
export const getCurrentUser = async () => {
  const token = await AsyncStorage.getItem('token');
  
  const res = await api.get('/api/auth/me', {
    headers: { Authorization: `Bearer ${token}` },
  });
  
  return res.data.user;
};

// Get posts
export const getPosts = async (skip = 0, limit = 20) => {
  const token = await AsyncStorage.getItem('token');
  
  const res = await api.get('/api/posts/', {
    params: { skip, limit },
    headers: { Authorization: `Bearer ${token}` },
  });
  
  return res.data.data.posts;
};

// Create note
export const createNote = async (title, textContent) => {
  const token = await AsyncStorage.getItem('token');
  const formData = new FormData();
  
  formData.append('content_type', 'note');
  formData.append('title', title);
  formData.append('text_content', textContent);
  
  const res = await api.post('/api/posts/', formData, {
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'multipart/form-data',
    },
  });
  
  return res.data.post;
};

// Delete post
export const deletePost = async (postId) => {
  const token = await AsyncStorage.getItem('token');
  
  await api.delete(`/api/posts/${postId}`, {
    headers: { Authorization: `Bearer ${token}` },
  });
};
```

---

## ‚ö†Ô∏è Error Handling

### HTTP Status Codes
| Code | Meaning | Action |
|------|---------|--------|
| 200 | Success | Process data |
| 201 | Created | Resource created |
| 400 | Bad Request | Show validation error |
| 401 | Unauthorized | Redirect to login |
| 403 | Forbidden | Show permission error |
| 404 | Not Found | Show not found error |
| 409 | Conflict | Show duplicate error |
| 422 | Validation Error | Show field errors |
| 500 | Server Error | Show generic error |

### Error Format
```json
{
  "success": false,
  "error": "Human-readable message"
}
```

### Example Handler
```javascript
try {
  await signup(username, email, password);
} catch (error) {
  if (error.response) {
    const { status, data } = error.response;
    
    if (status === 409) {
      showError(data.error); // "Username already taken"
    } else if (status === 400) {
      showError(data.error); // Validation error
    } else {
      showError('Something went wrong');
    }
  } else {
    showError('No internet connection');
  }
}
```

---

## üìù Important Notes

### 1. Trailing Slashes
Always include trailing slash for posts:
- ‚úÖ `/api/posts/`
- ‚ùå `/api/posts`

### 2. Free Tier Sleep Mode
- Server sleeps after 15 min inactivity
- First request takes ~30-50 seconds
- Show loading indicator for first request

### 3. Token Expiration
- Tokens expire eventually
- Handle 401 errors by redirecting to login
- Clear AsyncStorage on logout

### 4. userId Usage
- **Never show userId in UI**
- Use username for display
- userId is for backend only

---

## üéØ Quick Checklist

**For Signup Screen:**
- [ ] Username input (3-50 chars)
- [ ] Email input (valid email)
- [ ] Password input (6-128 chars)
- [ ] Check username availability on blur
- [ ] Show validation errors
- [ ] Store all response data

**For Login Screen:**
- [ ] Single input for username OR email
- [ ] Password input
- [ ] Handle both login methods
- [ ] Store all response data

**For Profile Screen:**
- [ ] Display username
- [ ] Display email
- [ ] Never display userId

**For Posts:**
- [ ] Include Authorization header
- [ ] Use FormData for creation
- [ ] Handle pagination
- [ ] Show author username (not userId)

---

## üöÄ Your Backend is Ready!

All endpoints are tested and production-ready at:
**`https://smriti-backend-r293.onrender.com`**
